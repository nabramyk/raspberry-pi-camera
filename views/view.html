<!DOCTYPE html>
<head>
	<script>

		var url = 'http://localhost:8080/';

		var still = ["aspect_width","aspect_height","encoding","quality","sharpness","contrast","brightness","saturation","iso","ev","exposure","aws","imxfx","metering","rotation","vflip","hflip","raw","output"];
		var yuv = ["aspect_width","aspect_height","sharpness","contrast","brightness","saturation","iso","ev","exposure","awb","imxfx","metering","rotation","hflip","vflip","vstab"];
		var video = ["aspect_width","aspect_height"];

		function take_image() {
			var xmlHttp = new XMLHttpRequest();
			var params = [];
			var sendToServer = "?" + document.getElementById("camera_mode").value + "&";
			
			if(document.getElementById("camera_mode").value==="raspistill") {
				params = still;
			} else if(document.getElementById("camera_mode").value==="raspivid") {
				params = video;
			} else {
				params = yuv;
			}
			
			for(var i = 0; i < params.length; i++) {
				sendToServer = sendToServer + document.getElementById(params[i]).name + "=" + document.getElementById(params[i]).value + "&";
			}
			
			xmlHttp.open("POST", url+"take_image/"+sendToServer, true);

			xmlHttp.send(null);
		}

		window.onload = function() {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function() {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					document.getElementById("selection_pane").innerHTML = xmlHttp.responseText;
					retrieve();
				}
			};
			xmlHttp.open("GET", 'http://localhost:8080/views/monitor/');
			xmlHttp.send(null);
		}
		
		function update() {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				i.innerHTML = xmlHttp.responseText;
				setTimeout(update, 1000);
				}
			}					
			xmlHttp.open("GET", 'http://localhost:8080/temp/');
			xmlHttp.send(null);
		}
		
		function show_hide_options(pane) {
			var x = document.getElementById(pane);
			if(x.style.display === 'none') {
				x.style.display = 'block';
			} else {
				x.style.display = 'none';
			}
		}
		
	//Arrays of object names which will be invisible depending on the camera mode
	var yuv_options = ["tags_pane","bayer_data_pane","encoding_pane","quality_pane","vid_stab_pane","bitrate_pane","framerate_pane","timeout_pane"];
	var still_options = ["vid_stab_pane","framerate_pane","bitrate_pane","timeout_pane"];
	var video_options = ["tags_pane","bayer_data_pane","timelapse_pane","quality_pane","encoding_pane"];
	
	var monitor_data_points = [	"camera_status",
								"cpu_temperature",
								"cpu_percent",
								"platform_machine",
								"platform_version",
								"platform_system",
								"platform_processor",
								"storage_total",
								"storage_used",
								"storage_free",
								"storage_percent"];
	
	function switch_camera_modes(mode) {	
		var options = null;
		if(mode==="raspistill") {
			options = still_options;
			document.getElementById("shutter_button").innerHTML = "Take Image";
		} else if(mode==="raspivid") {
			options = video_options;
			document.getElementById("shutter_button").innerHTML = "Record Video";
		} else if(mode==="raspiyuv") {
			options = yuv_options;
			document.getElementById("shutter_button").innerHTML = "Record Image";
		}
		var temp = document.querySelectorAll(".additional_camera_options");
		for(var i=0; i<temp.length; i++) {
			temp[i].style.display = 'block';
		}
		for(var i=0; i<options.length; i++) {
			document.getElementById(options[i]).style.display = 'none';
		}
	}
	
		function scale_aspect_ratio(axis, amount) {
			if(document.getElementById("aspect_ratio_lock").checked) {
				var ratio = document.getElementById("aspect_ratio").value;
				var width = ratio.split(":")[0];
				var height = ratio.split(":")[1];
				if(axis=="width") {
					document.getElementById("aspect_width").value = Math.round(amount * width / height);
				} else {
					document.getElementById("aspect_height").value = Math.round(amount * height / width);
				}
			}
		}
			
		function toggle_uv_mode(checked) {
			if(checked) {
				document.getElementById("u_channel").disabled = false;
				document.getElementById("y_channel").disabled = false;
				document.getElementById("encoding").disabled = true;
			} else {
				document.getElementById("u_channel").disabled = true;
				document.getElementById("y_channel").disabled = true;
				document.getElementById("encoding").disabled = false;
			}
		}
		
		function toggle_timelapse_mode(checked) {
			if(checked) {
				document.getElementById("timelapse_interval").disabled = false;
				document.getElementById("timelapse_time_unit").disabled = false;
				document.getElementById("shutter_button").innerHTML = "Begin Sequence";
			} else {
				document.getElementById("timelapse_interval").disabled = true;
				document.getElementById("timelapse_time_unit").disabled = true;
				document.getElementById("shutter_button").innerHTML = "Record Image";
			}
		}
		
		function toggle_encoding(val) {
			if(val==="jpg") {
				document.getElementById("quality_pane").style.display = 'block';
				document.getElementById("bayer_data_pane").style.display = 'block';
			} else {
				document.getElementById("quality_pane").style.display = 'none';
				document.getElementById("bayer_data_pane").style.display = 'none';
			}
		}
		
		function toggle_aspect_ratio(checked) {
				document.getElementById("aspect_ratio").disabled = !checked;
		}
		
		function retrieve() {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function() {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					var p = xmlHttp.responseXML;
					for (var i = 0; i < monitor_data_points.length; i++) {
						document.getElementById(monitor_data_points[i]).innerHTML = p.getElementsByTagName(monitor_data_points[i])[0].childNodes[0].nodeValue;
					}
					setTimeout(retrieve, 1000);
				}
			};
			xmlHttp.open("GET", 'http://localhost:8080/monitor/');
			xmlHttp.send(null);
		}
	
		function switch_modes(mode) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function() {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					document.getElementById("selection_pane").innerHTML = xmlHttp.responseText;
				}
			};			
			xmlHttp.open("GET", 'http://localhost:8080/views/' + mode + '/');
			xmlHttp.send(null);
			var params = document.getElementsByClassName("navigation_button");
			for(var i = 0; i < params.length; i++) {
				params[i].value="unselected";
			}
			document.getElementById(mode).value="selected";
		}
		
		function set_aspect_ratio(ratio) {
			var res = ratio.split("x");
			document.getElementById("aspect_width").value = res[0];
			document.getElementById("aspect_height").value = res[1];
		}
		
	</script>
	<link rel="stylesheet" type="text/css" href="http://localhost:8080/views/style.css">
</head>
	<body>
		<div id="main_panel">
		<div class="main_panel">
			<header>
				<h1 id="header">RasPiCam</h1>
			</header>
			<div id="navigation_menu">
				<button id="monitor" type="button" class="navigation_button" value="selected" onClick="switch_modes(this.id)">MONITOR</button>
				<button id="camera" type="button" class="navigation_button" value="unselected" onClick="switch_modes(this.id)">CAMERA</button>
				<button id="system_info" type="button" class="navigation_button" value="unselected" onclick="switch_modes(this.id)">SYSTEM INFO</button>
			</div>
			<div id="selection_pane"></div>
		</div>
		</div>
	</body>	
</html>
